# name: test/sql/pushdown/pushdown_behavior.test
# description: Test pushdown enabled/disabled behavior for snowflake_query vs ATTACH
# group: [pushdown]

require snowflake

require-env SNOWFLAKE_ACCOUNT

require-env SNOWFLAKE_USERNAME

require-env SNOWFLAKE_PASSWORD

require-env SNOWFLAKE_DATABASE

statement ok
LOAD snowflake;

# Create test secret
statement ok
CREATE SECRET test_secret (
    TYPE snowflake,
    ACCOUNT '${SNOWFLAKE_ACCOUNT}',
    USER '${SNOWFLAKE_USERNAME}',
    PASSWORD '${SNOWFLAKE_PASSWORD}',
    DATABASE '${SNOWFLAKE_DATABASE}'
);

# Test 1: ATTACH with enable_pushdown true
# DuckDB modifies the query to push filters and projections
# Base query "SELECT * FROM table" is modified by DuckDB optimizer
statement ok
ATTACH '' AS snow (TYPE snowflake, SECRET test_secret, READ_ONLY, enable_pushdown true);

# Enable profiling for pushdown comparison
statement ok
PRAGMA enable_profiling;

statement ok
PRAGMA profiling_output='pushdown_enabled_profile.json';

# Test 2: This query should result in pushdown
# EXPLAIN shows pushdown in action
statement ok
EXPLAIN SELECT C_CUSTKEY, C_NAME FROM snow.tpch_sf1.customer WHERE C_CUSTKEY <= 10;

statement ok
SELECT C_CUSTKEY, C_NAME FROM snow.tpch_sf1.customer WHERE C_CUSTKEY <= 10;

# Test 3: Verify projection pushdown on ATTACH
# Should only request needed columns from Snowflake
statement ok
SELECT C_CUSTKEY FROM snow.tpch_sf1.customer LIMIT 5;

# Test 4: Verify filter pushdown on ATTACH
# Should push WHERE clause to Snowflake
statement ok
SELECT * FROM snow.tpch_sf1.customer WHERE C_MKTSEGMENT = 'HOUSEHOLD' LIMIT 5;

# Test 5: Verify combined pushdown on ATTACH
# Should push both projection and filter
statement ok
SELECT C_CUSTKEY, C_MKTSEGMENT FROM snow.tpch_sf1.customer WHERE C_CUSTKEY > 100000 AND C_PHONE IS NOT NULL LIMIT 5;

# Test 6: IS NULL pushdown on ATTACH (likely returns 0 for this dataset)
statement ok
SELECT * FROM snow.tpch_sf1.customer WHERE C_COMMENT IS NULL;

# Test 7: IS NOT NULL pushdown on ATTACH
statement ok
SELECT * FROM snow.tpch_sf1.customer WHERE C_PHONE IS NOT NULL LIMIT 5;

# Test 8: Multiple comparison operators
# EXPLAIN shows multiple filter pushdown
statement ok
EXPLAIN SELECT * FROM snow.tpch_sf1.orders
WHERE O_ORDERKEY > 1000
  AND O_TOTALPRICE <= 10000.0
  AND O_ORDERSTATUS != 'P'
LIMIT 5;

statement ok
SELECT * FROM snow.tpch_sf1.orders
WHERE O_ORDERKEY > 1000
  AND O_TOTALPRICE <= 10000.0
  AND O_ORDERSTATUS != 'P'
LIMIT 5;

# Disable profiling for pushdown-enabled tests
statement ok
PRAGMA disable_profiling;

# Cleanup pushdown-enabled attachment
statement ok
DETACH snow;

# Test 9: Compare with PUSHDOWN DISABLED
# Re-attach without pushdown to show performance difference
statement ok
ATTACH '' AS snow_no_push (TYPE snowflake, SECRET test_secret, READ_ONLY);

# Enable profiling for comparison
statement ok
PRAGMA enable_profiling;

statement ok
PRAGMA profiling_output='pushdown_disabled_profile.json';

# Test 10: Same query without pushdown
# EXPLAIN should show filter applied locally in DuckDB
statement ok
EXPLAIN SELECT C_CUSTKEY, C_NAME FROM snow_no_push.tpch_sf1.customer WHERE C_CUSTKEY <= 10;

statement ok
SELECT C_CUSTKEY, C_NAME FROM snow_no_push.tpch_sf1.customer WHERE C_CUSTKEY <= 10;

# Disable profiling
statement ok
PRAGMA disable_profiling;

# Note: pragma_last_profiling_output() not available in DuckDB v1.4.0
# Profile data is written to pushdown_disabled_profile.json instead

# Cleanup
statement ok
DETACH snow_no_push;

statement ok
DROP SECRET test_secret;
